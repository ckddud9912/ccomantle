<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê¼¬ë§¨í‹€ ê²Œì„</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #0d1117;
        color: #fff;
        margin: 0;
        padding: 40px;
        display: flex;
        gap: 40px;
    }

    .left-box {
        width: 40%;
        background: #111827;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #1f2937;
    }

    input, select {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #374151;
        background: #1f2937;
        color: #fff;
        font-size: 16px;
    }

    #teamColor {
        width: 100%;
        margin-top: 10px;
        height: 45px;
        border-radius: 8px;
        cursor: pointer;
        padding: 0;
        border: none;
    }

    button {
        margin-top: 15px;
        width: 100%;
        padding: 12px;
        background: #fbbf24;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
    }

    .right-box {
        flex-grow: 1;
        background: #111827;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #1f2937;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 15px;
        text-align: center;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #374151;
    }

    .rank-bar-box {
        width: 100%;
        height: 10px;
        background: #374151;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 4px;
    }

    .rank-bar-fill {
        height: 100%;
        transition: width 0.4s ease;
    }

    .new-row {
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
</head>

<body>

<div class="left-box">
    <h1>ğŸ® ê¼¬ë§¨í‹€ ê²Œì„</h1>

    <input id="team" placeholder="íŒ€ ì´ë¦„ ì…ë ¥">

    <!-- íŒ€ ìƒ‰ìƒ ì„ íƒ ì¶”ê°€ -->
    <label style="margin-top:10px; display:block; opacity:0.8;">íŒ€ ìƒ‰ìƒ ì„ íƒ</label>
    <input type="color" id="teamColor">

    <input id="word" placeholder="ì œì¶œ ë‹¨ì–´ ì…ë ¥">

    <button onclick="sendGuess()">ì œì¶œ</button>

    <div id="latest"></div>
</div>

<div class="right-box">
    <h2>ğŸ† ë¦¬ë”ë³´ë“œ</h2>

    <p class="hint-box">
        ìµœìƒìœ„ ìœ ì‚¬ë„: <span id="best"></span><br>
        20ìœ„ ìœ ì‚¬ë„: <span id="tw"></span><br>
        1000ìœ„ ìœ ì‚¬ë„: <span id="th"></span>
    </p>

    <table>
        <thead>
            <tr>
                <th>ìˆœìœ„</th>
                <th>íŒ€</th>
                <th>ë‹¨ì–´</th>
                <th>ìœ ì‚¬ë„</th>
                <th>ìœ ì‚¬ë„ ìˆœìœ„</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script>
let teamColors = {};           // íŒ€ ì´ë¦„ â†’ ìƒ‰ìƒ ë§¤í•‘
let seenEntries = new Set();   // ì‹ ê·œ ë‹¨ì–´ íŒë‹¨ìš©

// íŒ€ ìƒ‰ìƒ ê²°ì • (ì§ì ‘ ì„ íƒ ê°€ëŠ¥)
function getTeamColor(team) {
    if (teamColors[team]) return teamColors[team];

    // íŒ€ì´ ìƒ‰ì„ ì§ì ‘ ì„ íƒí•œ ê²½ìš° ìš°ì„  ì ìš©
    const selected = document.getElementById("teamColor").value;
    if (selected) {
        teamColors[team] = selected;
        return selected;
    }

    // ì—†ë‹¤ë©´ ëœë¤ ìƒ‰
    const newColor = "#" + Math.floor(Math.random()*16777215).toString(16);
    teamColors[team] = newColor;
    return newColor;
}

// Enter ì…ë ¥ìœ¼ë¡œ ì œì¶œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
document.getElementById("word").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        sendGuess();
    }
});

async function sendGuess() {
    const team = document.getElementById("team").value.trim();
    const word = document.getElementById("word").value.trim();
    if (!team || !word) return;

    // íŒ€ ìƒ‰ ì €ì¥
    const selectedColor = document.getElementById("teamColor").value;
    if (selectedColor) teamColors[team] = selectedColor;

    const res = await fetch("/guess", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ team, word })
    });
    const data = await res.json();

    if (data.entry) {
        const textRank = data.entry.is_answer ? "ì •ë‹µ!" : data.entry.rank;
        document.getElementById("latest").innerText =
            `[${data.entry.team}] ${data.entry.word} â†’ ìœ ì‚¬ë„ ${data.entry.similarity.toFixed(3)} / ${textRank}`;
    }

    loadBoard();
}

async function loadBoard() {
    const res = await fetch("/leaderboard");
    const data = await res.json();

    document.getElementById("best").innerText = data.sim_top1?.toFixed(3) || "-";
    document.getElementById("tw").innerText = data.sim_top20?.toFixed(3) || "-";
    document.getElementById("th").innerText = data.sim_top1000?.toFixed(3) || "-";

    const tb = document.getElementById("tbody");
    tb.innerHTML = "";

    let rankNum = 1;

    for (let row of data.submissions) {
        const key = row.team + "_" + row.word;

        const tr = document.createElement("tr");

        if (!seenEntries.has(key)) {
            tr.classList.add("new-row");
            seenEntries.add(key);
        }

        // ì •ë‹µ í‘œì‹œ
        let rankText = row.rank;
        if (row.is_answer) {
            rankText = "ì •ë‹µ!";
        } else if (row.rank === "???" || row.rank > 1000) {
            rankText = "1000ìœ„ ì´ìƒ";
        }

        // ìˆœìœ„ ë§‰ëŒ€
        let barWidth = 0;
        if (typeof row.rank === "number" && row.rank <= 1000 && !row.is_answer) {
            barWidth = ((1000 - row.rank) / 1000) * 100;
        } else if (row.is_answer) {
            barWidth = 100;
        }

        tr.innerHTML = `
            <td>${rankNum++}</td>
            <td>${row.team}</td>
            <td>${row.word}</td>
            <td>${row.similarity.toFixed(3)}</td>
            <td>
                ${rankText}
                <div class="rank-bar-box">
                    <div class="rank-bar-fill"
                        style="width:${barWidth}%; background:${getTeamColor(row.team)};">
                    </div>
                </div>
            </td>
        `;

        tb.appendChild(tr);
    }
}

loadBoard();
setInterval(loadBoard, 1500);
</script>

</body>
</html>
