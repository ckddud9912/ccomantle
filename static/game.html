<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¼¬ë§¨í‹€ ê²Œì„</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .grid-2x2 {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      grid-template-rows: 1.1fr 1.1fr;
      gap: 24px;
      height: calc(100vh - 48px);
    }

    .panel {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1e293b;
      padding: 18px 20px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.65);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* 1ë²ˆ íŒ¨ë„: ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
    #panel-input {
      overflow-y: auto;
    }

    .panel h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 700;
      color: #fbbf24;
    }

    .panel small {
      opacity: 0.8;
      font-size: 12px;
    }

    .field-label {
      margin-top: 14px;
      font-size: 13px;
      opacity: 0.9;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    input[type="color"] {
      width: 60px;
      height: 32px;
      padding: 0;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #020617;
      cursor: pointer;
    }

    button {
      margin-top: 18px;
      width: 100%;
      padding: 11px 12px;
      background: #facc15;
      color: #111827;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    button:hover {
      filter: brightness(1.05);
    }

    .latest-text {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
    }

    .meta-line {
      font-size: 12px;
      margin-top: 6px;
      opacity: 0.85;
    }

    .round-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      margin-top: 4px;
      padding: 3px 9px;
      border-radius: 999px;
      background: #0f172a;
      border: 1px solid #1e293b;
    }

    .round-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }

    th, td {
      padding: 7px 6px;
      border-bottom: 1px solid #111827;
      text-align: center;
      white-space: nowrap;
    }

    th {
      font-size: 12px;
      color: #9ca3af;
      font-weight: 500;
    }

    .tbody-scroll {
      overflow-y: auto;
      margin-top: 6px;
      flex: 1;
    }

    .row-team {
      font-weight: 600;
    }

    .sim-good { color: #22c55e; }
    .sim-bad { color: #f97316; }

    .rank-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #1e293b;
      background: #020617;
      min-width: 60px;
    }

    .rank-answer {
      border-color: #facc15;
      color: #facc15;
      font-weight: 700;
    }

    .bar-box {
      width: 100%;
      height: 8px;
      background: #020617;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #111827;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      transition: width 0.4s ease-out;
      background: #3b82f6;
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .panel-subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .round-label {
      font-size: 13px;
      font-weight: 600;
      margin-top: 4px;
      color: #e5e7eb;
    }

    .round-tag {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      background: #0f172a;
      font-size: 11px;
      color: #9ca3af;
      margin-left: 4px;
    }

    .past-scroll {
      flex: 1;
      overflow-y: auto;
      margin-top: 6px;
    }

    .past-table-wrapper {
      margin-bottom: 12px;
      border-radius: 10px;
      border: 1px solid #111827;
      padding: 6px 6px 4px 6px;
      background: #020617;
    }

    .past-table-wrapper h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
    }

    .no-data {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 8px;
    }

    /* ìµœì¢… ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
    #final-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.96);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #final-card {
      width: min(700px, 90vw);
      max-height: 80vh;
      background: #020617;
      border-radius: 18px;
      border: 1px solid #1e293b;
      padding: 20px 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
    }

    #final-card h2 {
      margin: 0 0 10px 0;
      font-size: 22px;
      color: #fbbf24;
    }

    #final-card p {
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #9ca3af;
    }

    #final-body {
      flex: 1;
      overflow-y: auto;
      margin-top: 4px;
    }

    #final-close {
      margin-top: 14px;
      align-self: flex-end;
      width: auto;
      padding: 7px 12px;
      font-size: 13px;
      background: #111827;
      color: #e5e7eb;
    }

    #final-table th, #final-table td {
      padding: 7px 6px;
    }
  </style>
</head>
<body>
<div class="grid-2x2">
  <!-- 1ë²ˆ ì˜ì—­: ì…ë ¥ -->
  <section class="panel" id="panel-input">
    <h2>ğŸ® ê¼¬ë§¨í‹€ ê²Œì„</h2>
    <small>ì •ë‹µì€ í•˜ë‚˜, 6ë¼ìš´ë“œ ì•ˆì— ìµœëŒ€í•œ ê°€ê¹Œì´ ë‹¤ê°€ê°€ ë³´ì„¸ìš”.</small>

    <div class="round-badge" id="round-badge">
      <span class="round-dot"></span>
      <span id="round-label">í˜„ì¬ ë¼ìš´ë“œ: - / 6</span>
    </div>

    <div class="meta-line" id="sim-meta">
      ìµœìƒìœ„ ìœ ì‚¬ë„: <span id="sim-top1">-</span>,
      20ìœ„ ìœ ì‚¬ë„: <span id="sim-top20">-</span>,
      1000ìœ„ ìœ ì‚¬ë„: <span id="sim-top1000">-</span>
    </div>

    <div class="field-label">íŒ€ ì´ë¦„</div>
    <input type="text" id="team" placeholder="ì˜ˆ: ë¸”ë£¨íŒ€" />

    <div class="field-label">íŒ€ ìƒ‰ìƒ ì„ íƒ</div>
    <input type="color" id="teamColor" value="#3b82f6" />

    <div class="field-label">ì œì¶œ ë‹¨ì–´</div>
    <input type="text" id="word" placeholder="ì˜ˆ: ì •ìˆ˜ / ê¸°ëŒ€ / ë°°ê³ í””" />

    <button id="submitBtn" onclick="sendGuess()">ì œì¶œ</button>

    <div class="latest-text" id="latest"></div>
  </section>

  <!-- 2ë²ˆ ì˜ì—­: í˜„ì¬ ë¼ìš´ë“œ ë¦¬ë”ë³´ë“œ -->
  <section class="panel" id="panel-current">
    <div class="panel-title-row">
      <h2>ğŸ† í˜„ì¬ ë¼ìš´ë“œ ë¦¬ë”ë³´ë“œ</h2>
      <div class="panel-subtitle" id="answer-label"></div>
    </div>

    <div class="round-label">
      í˜„ì¬ ë¼ìš´ë“œ: <span id="current-round-text">-</span>
      <span class="round-tag">ì‹¤ì‹œê°„ ë°˜ì˜</span>
    </div>

    <div class="tbody-scroll">
      <table>
        <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>íŒ€</th>
          <th>ë‹¨ì–´</th>
          <th>ìœ ì‚¬ë„</th>
          <th>ìœ ì‚¬ë„ ìˆœìœ„</th>
          <th>ë§‰ëŒ€</th>
        </tr>
        </thead>
        <tbody id="tbody-current"></tbody>
      </table>
    </div>
  </section>

  <!-- 3ë²ˆ ì˜ì—­: ê³¼ê±° ë¼ìš´ë“œ (í™€ìˆ˜) -->
  <section class="panel" id="panel-past-left">
    <div class="panel-title-row">
      <h2>ğŸ“œ ê³¼ê±° ë¼ìš´ë“œ (1,3,5â€¦)</h2>
      <div class="panel-subtitle">ì´ì „ ë¼ìš´ë“œ ê¸°ë¡</div>
    </div>
    <div class="past-scroll" id="past-left"></div>
  </section>

  <!-- 4ë²ˆ ì˜ì—­: ê³¼ê±° ë¼ìš´ë“œ (ì§ìˆ˜) -->
  <section class="panel" id="panel-past-right">
    <div class="panel-title-row">
      <h2>ğŸ“œ ê³¼ê±° ë¼ìš´ë“œ (2,4,6â€¦)</h2>
      <div class="panel-subtitle">ì´ì „ ë¼ìš´ë“œ ê¸°ë¡</div>
    </div>
    <div class="past-scroll" id="past-right"></div>
  </section>
</div>

<!-- ìµœì¢… ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
<div id="final-overlay">
  <div id="final-card">
    <h2>ğŸ ìµœì¢… ê²°ê³¼</h2>
    <p>ê²½ê¸°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. íŒ€ë³„ í‰ê·  ìœ ì‚¬ë„ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    <div id="final-body">
      <table id="final-table">
        <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>íŒ€</th>
          <th>í‰ê·  ìœ ì‚¬ë„</th>
        </tr>
        </thead>
        <tbody id="final-tbody"></tbody>
      </table>
    </div>
    <button id="final-close">ë‹«ê¸°</button>
  </div>
</div>

<script>
  const teamColors = {};
  let lastCorrectKey = null;
  let pollId = null;

  document.getElementById("word").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      sendGuess();
    }
  });

  document.getElementById("final-close").addEventListener("click", () => {
    document.getElementById("final-overlay").style.display = "none";
  });

  function getTeamColor(team) {
    if (!teamColors[team]) {
      const colorInput = document.getElementById("teamColor");
      if (colorInput && colorInput.value) {
        teamColors[team] = colorInput.value;
      } else {
        teamColors[team] = "#" + Math.floor(Math.random() * 16777215).toString(16).padStart(6, "0");
      }
    }
    return teamColors[team];
  }

  async function sendGuess() {
    const team = document.getElementById("team").value.trim();
    const word = document.getElementById("word").value.trim();
    if (!team || !word) return;

    try {
      const res = await fetch("/guess", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ team, word })
      });
      const data = await res.json();

      if (data.error) {
        document.getElementById("latest").innerText = data.error;
        return;
      }

      if (data.result === "duplicate") {
        document.getElementById("latest").innerText = "ì´ë¯¸ ì´ ë¼ìš´ë“œì—ì„œ ì œì¶œí–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      if (data.entry) {
        const e = data.entry;
        document.getElementById("latest").innerText =
          `[${e.round}R][${e.team}] ${e.word} â†’ ìœ ì‚¬ë„ ${e.similarity?.toFixed(3) ?? "-"}` +
          (e.rank ? ` / ${e.rank}ìœ„` : "");

        if (data.result === "correct") {
          lastCorrectKey = `${e.round}::${e.team}::${e.word}`;
        }
      }

      document.getElementById("word").value = "";
      await loadBoard();
    } catch (err) {
      console.error(err);
    }
  }

  async function loadBoard() {
    try {
      const res = await fetch("/leaderboard");
      const data = await res.json();

      if (data.finished) {
        if (pollId) {
          clearInterval(pollId);
          pollId = null;
        }
        await loadFinalResult();
        return;
      }

      const currentRound = data.current_round;
      const maxRounds = data.max_rounds;
      const rounds = data.rounds || {};

      document.getElementById("round-label").innerText =
        `í˜„ì¬ ë¼ìš´ë“œ: ${currentRound} / ${maxRounds}`;
      document.getElementById("current-round-text").innerText = `${currentRound} ë¼ìš´ë“œ`;

      document.getElementById("sim-top1").innerText = data.sim_top1 ? data.sim_top1.toFixed(3) : "-";
      document.getElementById("sim-top20").innerText = data.sim_top20 ? data.sim_top20.toFixed(3) : "-";
      document.getElementById("sim-top1000").innerText = data.sim_top1000 ? data.sim_top1000.toFixed(3) : "-";

      document.getElementById("answer-label").innerText =
        data.answer ? `í˜„ì¬ ì •ë‹µ ë‹¨ì–´ëŠ” ì–´ë“œë¯¼ì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤.` : "ì •ë‹µì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";

      renderCurrentRound(rounds[String(currentRound)] || [], currentRound);
      renderPastRounds(rounds, currentRound);
    } catch (err) {
      console.error(err);
    }
  }

  function renderCurrentRound(rows, roundNo) {
    const tbody = document.getElementById("tbody-current");
    tbody.innerHTML = "";

    rows.forEach((row, idx) => {
      const tr = document.createElement("tr");

      const tdRank = document.createElement("td");
      tdRank.textContent = idx + 1;
      tr.appendChild(tdRank);

      const tdTeam = document.createElement("td");
      tdTeam.textContent = row.team;
      tdTeam.className = "row-team";
      tdTeam.style.color = getTeamColor(row.team); // íŒ€ ì´ë¦„ì— ìƒ‰ ì ìš©
      tr.appendChild(tdTeam);

      const tdWord = document.createElement("td");
      tdWord.textContent = row.word;
      tr.appendChild(tdWord);

      const tdSim = document.createElement("td");
      if (typeof row.similarity === "number") {
        tdSim.textContent = row.similarity.toFixed(3);
        tdSim.className = row.similarity >= 0.6 ? "sim-good" : "sim-bad";
      } else {
        tdSim.textContent = "-";
      }
      tr.appendChild(tdSim);

      const tdRankInfo = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "rank-pill";
      pill.textContent = formatRank(row);
      if (row.is_answer) pill.classList.add("rank-answer");
      tdRankInfo.appendChild(pill);
      tr.appendChild(tdRankInfo);

      const tdBar = document.createElement("td");
      const box = document.createElement("div");
      box.className = "bar-box";
      const fill = document.createElement("div");
      fill.className = "bar-fill";

      let pct = 0;
      if (row.is_answer) {
        pct = 100;
      } else if (row.rank && row.rank <= 1000) {
        pct = Math.max(5, (1000 - row.rank + 1) / 1000 * 100);
      } else {
        pct = 0;
      }
      fill.style.width = pct + "%";

      box.appendChild(fill);
      tdBar.appendChild(box);
      tr.appendChild(tdBar);

      const key = `${roundNo}::${row.team}::${row.word}`;
      if (lastCorrectKey && key === lastCorrectKey) {
        tr.style.outline = "2px solid #facc15";
        tr.style.boxShadow = "0 0 10px rgba(250, 204, 21, 0.8)";
        setTimeout(() => {
          tr.style.outline = "none";
          tr.style.boxShadow = "none";
          lastCorrectKey = null;
        }, 1200);
      }

      tbody.appendChild(tr);
    });

    if (rows.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.className = "no-data";
      td.textContent = "ì•„ì§ ì œì¶œëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  }

  function formatRank(row) {
    if (row.is_answer) return "ì •ë‹µ!";
    if (!row.rank || row.rank > 1000) return "1000ìœ„ ì´ìƒ";
    return `${row.rank}ìœ„`;
  }

  function renderPastRounds(rounds, currentRound) {
    const left = document.getElementById("past-left");
    const right = document.getElementById("past-right");
    left.innerHTML = "";
    right.innerHTML = "";

    let hasLeft = false;
    let hasRight = false;

    for (let r = 1; r < currentRound; r++) {
      const list = rounds[String(r)] || [];
      if (!list.length) continue;

      const target = (r % 2 === 1) ? left : right;
      if (r % 2 === 1) hasLeft = true; else hasRight = true;

      const wrapper = document.createElement("div");
      wrapper.className = "past-table-wrapper";

      const title = document.createElement("div");
      title.style.display = "flex";
      title.style.justifyContent = "space-between";
      title.style.alignItems = "baseline";

      const h = document.createElement("h3");
      h.textContent = `${r} ë¼ìš´ë“œ`;
      title.appendChild(h);

      const sub = document.createElement("span");
      sub.style.fontSize = "11px";
      sub.style.color = "#9ca3af";
      sub.textContent = `${list.length}ê°œ ì œì¶œ`;
      title.appendChild(sub);

      wrapper.appendChild(title);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>ìˆœìœ„</th>
          <th>íŒ€</th>
          <th>ë‹¨ì–´</th>
          <th>ìœ ì‚¬ë„</th>
          <th>ìœ ì‚¬ë„ ìˆœìœ„</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      list.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const tdRank = document.createElement("td");
        tdRank.textContent = idx + 1;
        tr.appendChild(tdRank);

        const tdTeam = document.createElement("td");
        tdTeam.textContent = row.team;
        tdTeam.style.color = getTeamColor(row.team);
        tr.appendChild(tdTeam);

        const tdWord = document.createElement("td");
        tdWord.textContent = row.word;
        tr.appendChild(tdWord);

        const tdSim = document.createElement("td");
        tdSim.textContent =
          typeof row.similarity === "number" ? row.similarity.toFixed(3) : "-";
        tr.appendChild(tdSim);

        const tdRankInfo = document.createElement("td");
        tdRankInfo.textContent = formatRank(row);
        tr.appendChild(tdRankInfo);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wrapper.appendChild(table);
      target.appendChild(wrapper);
    }

    if (!hasLeft) {
      const n = document.createElement("div");
      n.className = "no-data";
      n.textContent = "í‘œì‹œí•  ê³¼ê±° ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
      left.appendChild(n);
    }

    if (!hasRight) {
      const n = document.createElement("div");
      n.className = "no-data";
      n.textContent = "í‘œì‹œí•  ê³¼ê±° ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
      right.appendChild(n);
    }
  }

  async function loadFinalResult() {
    try {
      const res = await fetch("/final_result");
      const data = await res.json();
      const tbody = document.getElementById("final-tbody");
      tbody.innerHTML = "";

      (data.result || []).forEach((row, idx) => {
        const tr = document.createElement("tr");

        const tdRank = document.createElement("td");
        tdRank.textContent = idx + 1;
        tr.appendChild(tdRank);

        const tdTeam = document.createElement("td");
        tdTeam.textContent = row.team;
        tdTeam.style.color = getTeamColor(row.team);
        tr.appendChild(tdTeam);

        const tdAvg = document.createElement("td");
        tdAvg.textContent = row.avg.toFixed(3);
        tr.appendChild(tdAvg);

        tbody.appendChild(tr);
      });

      document.getElementById("final-overlay").style.display = "flex";
    } catch (e) {
      console.error(e);
    }
  }

  // ì´ˆê¸° ì‹¤í–‰
  loadBoard();
  pollId = setInterval(loadBoard, 1500);
</script>
</body>
</html>
